<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Object Equality | Peter Mackay</title>
<meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Introduction
One of the first code smells we encounter when working with an object-oriented language where everything is an object, or everything subclasses a common base class, or there are no static methods, is how OOP typically handles equality of objects.
For value types such as integers and floating point numbers, it&rsquo;s not controversial that we should be able to compare them and decide if they&rsquo;re equal or not. Integers can be compared by bits, and data structures can be compared by descending into the structure and comparing elements."><meta name=generator content="Hugo 0.140.1"><meta name=robots content="index, follow"><link rel=stylesheet href=/ananke/css/main.min.59ce02eddf15260b506a9352ecc773e6fa3df2f9f2c2f46cd1ed6c8c90355170.css><link rel=canonical href=https://petmac.dev/posts/object-equality/><meta property="og:url" content="https://petmac.dev/posts/object-equality/"><meta property="og:site_name" content="Peter Mackay"><meta property="og:title" content="Object Equality"><meta property="og:description" content="Introduction One of the first code smells we encounter when working with an object-oriented language where everything is an object, or everything subclasses a common base class, or there are no static methods, is how OOP typically handles equality of objects.
For value types such as integers and floating point numbers, it’s not controversial that we should be able to compare them and decide if they’re equal or not. Integers can be compared by bits, and data structures can be compared by descending into the structure and comparing elements."><meta property="og:locale" content="en_gb"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-01T15:26:29+00:00"><meta property="article:modified_time" content="2022-04-01T15:26:29+00:00"><meta itemprop=name content="Object Equality"><meta itemprop=description content="Introduction One of the first code smells we encounter when working with an object-oriented language where everything is an object, or everything subclasses a common base class, or there are no static methods, is how OOP typically handles equality of objects.
For value types such as integers and floating point numbers, it’s not controversial that we should be able to compare them and decide if they’re equal or not. Integers can be compared by bits, and data structures can be compared by descending into the structure and comparing elements."><meta itemprop=datePublished content="2022-04-01T15:26:29+00:00"><meta itemprop=dateModified content="2022-04-01T15:26:29+00:00"><meta itemprop=wordCount content="2041"><meta name=twitter:card content="summary"><meta name=twitter:title content="Object Equality"><meta name=twitter:description content="Introduction One of the first code smells we encounter when working with an object-oriented language where everything is an object, or everything subclasses a common base class, or there are no static methods, is how OOP typically handles equality of objects.
For value types such as integers and floating point numbers, it’s not controversial that we should be able to compare them and decide if they’re equal or not. Integers can be compared by bits, and data structures can be compared by descending into the structure and comparing elements."></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">Peter Mackay</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Blog Posts page">Blog Posts</a></li></ul><div class=ananke-socials><a href=https://mastodon.gamedev.place/@petmac target=_blank rel=noopener class="ananke-social-link link-transition mastodon link dib z-999 pt3 pt0-l mr1" title="follow on Mastodon - Opens in a new window" aria-label="follow on Mastodon - Opens in a new window"><span class=icon><svg viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a href=https://bsky.app/profile/petmac.bsky.social target=_blank rel=noopener class="ananke-social-link link-transition bluesky link dib z-999 pt3 pt0-l mr1" title="follow on Bluesky - Opens in a new window" aria-label="follow on Bluesky - Opens in a new window"><span class=icon><svg viewBox="0 0 576 512"><path d="M407.8 294.7c-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3zM288 227.1C261.9 176.4 190.9 81.9 124.9 35.3 61.6-9.4 37.5-1.7 21.6 5.5 3.3 13.8.0 41.9.0 58.4S9.1 194 15 213.9c19.5 65.7 89.1 87.9 153.2 80.7 3.3-.5 6.6-.9 10-1.4-3.3.5-6.6 1-10 1.4-93.9 14-177.3 48.2-67.9 169.9C220.6 589.1 265.1 437.8 288 361.1c22.9 76.7 49.2 222.5 185.6 103.4 102.4-103.4 28.1-156-65.8-169.9-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3 64.1 7.1 133.6-15.1 153.2-80.7C566.9 194 576 75 576 58.4s-3.3-44.7-21.6-52.9c-15.8-7.1-40-14.9-103.2 29.8C385.1 81.9 314.1 176.4 288 227.1z"/></svg>
</span></a><a href=https://github.com/petmac/ target=_blank rel=noopener class="ananke-social-link link-transition github link dib z-999 pt3 pt0-l mr1" title="follow on GitHub - Opens in a new window" aria-label="follow on GitHub - Opens in a new window"><span class=icon><svg viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></a><a href=https://twitter.com/petmac target=_blank rel=noopener class="ananke-social-link link-transition twitter link dib z-999 pt3 pt0-l mr1" title="follow on Twitter - Opens in a new window" aria-label="follow on Twitter - Opens in a new window"><span class=icon><svg viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span></a></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked ttu">Blog Posts</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Object Equality</h1><time class="f6 mv4 dib tracked" datetime=2022-04-01T15:26:29Z>April 1, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=introduction>Introduction</h2><p>One of the first code smells we encounter when working with an object-oriented language where everything is an <em>object</em>, or everything subclasses a common base class, or there are no static methods, is how OOP typically handles equality of objects.</p><p>For value types such as integers and floating point numbers, it&rsquo;s not controversial that we should be able to compare them and decide if they&rsquo;re equal or not. Integers can be compared by bits, and data structures can be compared by descending into the structure and comparing elements.</p><p>For types passed by reference, such as classes in Java, C#, Swift, Objective-C and so on, it&rsquo;s extremely complicated. Sometimes we care about equality (two references point to different objects, but those objects contain the same values) and sometimes we care about identity (two references point to the same object.)</p><h2 id=properties-of-equatability>Properties of equatability</h2><p>There are a few properties of equatability that we can consider to help us recognise whether a language has a good quality equality solution, or not.</p><h3 id=equals-expressions-should-be-_commutative_>Equals expressions should be <em>commutative</em></h3><p>That is, &ldquo;is A equal to B?&rdquo; should always evaluate to the same boolean value as &ldquo;is B equal to A?&rdquo; How does that square with a typical OO solution to equality, where you have to compare values like the following snippet?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span>a.equals(b)
</span></span></code></pre></div><p>By giving the left-hand value in the comparison a special role &ndash; i.e., the calculator of the result &ndash; if we were to reverse the order of <code>a</code> and <code>b</code>, we could then be calling the equals method of a completely different type! In that case, there is no guarantee of commutativity.</p><p>For this reason, the equals function or operator <em>should not be an instance method</em>. The equality function should be a <em>static method</em> or even a <em>free function</em>.</p><h3 id=values-can-only-be-equal-if-they-are-of-the-same-type>Values can only be equal if they are of the same type</h3><p>For example, with basic types:</p><ul><li>Integers of the same width can be compared trivially</li><li>Integers of different widths can be compared, if they can be promoted to a larger width</li><li>Floating point numbers of the same width can be compared trivially</li><li>Single-precision floating point numbers can be compared with double-precision numbers</li><li>Integers and floating point numbers can be compared, if the integer can be promoted to a floating point number without loss of precision</li></ul><p>For more complex types, such as data structures:</p><ul><li>Two data structures of the same type can be compared fairly trivially by comparing the contents</li><li>Two data structures of unrelated types <em>can never</em> be equal</li><li>Two data structures of related types can also <em>never</em> be equal, because one type will have data or some other attribute that is missing from the other</li></ul><p>For this reason, a language should (at compile time) forbid comparisons of incompatible types.</p><h3 id=null-references>Null references</h3><p>For languages which burden programmers with null references, they have a few properties when compared:</p><ul><li>Nulls are always equal</li><li>A null is never equal to a non-null</li><li>Two non-nulls may be equal in terms of reference equality or value equality</li></ul><p>While these properties are fairly easy to check, requiring the programmer to do it manually results in lots of error-prone boilerplate that will likely be glossed over in code reviews.</p><p>Languages should not allow comparisons involving nulls, because the result is always known.</p><p>Additionally, languages should automatically generate equality code, in order to reduce boilerplate.</p><h2 id=deep-dive-into-c>Deep dive into C#</h2><p>Microsoft has documented <a href=https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/statements-expressions-operators/how-to-define-value-equality-for-a-type>how to define value equality for a class or struct</a>. It&rsquo;s a bit of a wild ride.</p><p>I believe Microsoft has somewhat addressed the deficiencies of their initial approach to value equality, with <a href=https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/record>Record</a>, but I haven&rsquo;t used C# since <code>Record</code> was introduced.</p><p>Long story short, it took Microsoft a long time to identify C# equality as a disaster, and when they did, they had to introduce a completely new type of type to fix it. Ouch!</p><p>Anyway, here is the example Microsoft provides for class equality:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TwoDPoint</span> : IEquatable&lt;TwoDPoint&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> X { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> Y { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> TwoDPoint(<span style=color:#66d9ef>int</span> x, <span style=color:#66d9ef>int</span> y)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Removed for brevity</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>bool</span> Equals(<span style=color:#66d9ef>object</span> obj) =&gt; <span style=color:#66d9ef>this</span>.Equals(obj <span style=color:#66d9ef>as</span> TwoDPoint);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> Equals(TwoDPoint p)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (p <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Optimization for a common success case.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (Object.ReferenceEquals(<span style=color:#66d9ef>this</span>, p))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If run-time types are not exactly the same, return false.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.GetType() != p.GetType())
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Return true if the fields match.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Note that the base class is not invoked because it is</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// System.Object, which defines Equals as reference equality.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (X == p.X) &amp;&amp; (Y == p.Y);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>int</span> GetHashCode() =&gt; (X, Y).GetHashCode();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>operator</span> ==(TwoDPoint lhs, TwoDPoint rhs)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (lhs <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (rhs <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Only the left side is null.</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Equals handles case of null on right side.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> lhs.Equals(rhs);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>operator</span> !=(TwoDPoint lhs, TwoDPoint rhs) =&gt; !(lhs == rhs);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This class is a container for 8 bytes. We&rsquo;re going to do a <em>lot</em> of work to compare these 8 bytes against another 8 bytes. Let&rsquo;s dig in.</p><h3 id=systemobjectequals-override><code>System.Object.Equals</code> override</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>bool</span> Equals(<span style=color:#66d9ef>object</span> obj) =&gt; <span style=color:#66d9ef>this</span>.Equals(obj <span style=color:#66d9ef>as</span> TwoDPoint);
</span></span></code></pre></div><p>To override <code>System.Object.Equals</code>, it appears to be best practice to do a run-time cast of <code>obj</code> to our class type, which will result in either a reference to our class, or reference to a subclass, or a null pointer, and then we pass that into a different, more specific, <code>Equals</code> method to do the work.</p><p>As opposed to the call being clear and unambiguous, we rely on language-lawyer knowledge to know which <code>Equals</code> method we&rsquo;re calling into. We&rsquo;re not recursing into the same method again, we&rsquo;re calling a <em>different</em> <code>Equals</code> method.</p><blockquote><p>There are two ways of constructing a software design. One way is to make it so simple that there are <strong>obviously</strong> no deficiencies. And the other way is to make it so complicated that there are no <strong>obvious</strong> deficiencies.</p><p>&ndash; <a href=https://wiki.c2.com/?TwoWaysToDesign>Tony Hoare</a></p></blockquote><p>(Thank you <a href=https://twitter.com/venkat_s>Dr. Venkat Subramaniam</a> for clarifying the author of the above quote.)</p><h3 id=iequatabletequals-implementation><code>IEquatable&lt;T>.Equals</code> implementation</h3><p>Acknowledging that <code>System.Object.Equals</code> is terrible, Microsoft provided <em>another</em> equality mechanism: The interface <code>IEquatable&lt;T></code>. This improves on the previous approach by allowing the programmer to constrain the types of object that we can compare equality to. Sounds good, right?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> Equals(TwoDPoint p)
</span></span></code></pre></div><p>We&rsquo;re off to a good start, the function signature has the class we&rsquo;re interested in.</p><p>Each implementation has to check that the object passed in is not null. That&rsquo;s not great:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>if</span> (p <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Not strictly required, but each implementation <em>should</em> check that the two objects aren&rsquo;t in fact the same object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Optimization for a common success case.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (Object.ReferenceEquals(<span style=color:#66d9ef>this</span>, p))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Based on the method signature, we thought we were already talking about two objects of the same type, but that was a trick to keep us on our toes. We need to double-check that neither object has been subclassed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// If run-time types are not exactly the same, return false.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.GetType() != p.GetType())
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally, after a dozen lines of boilerplate, we reach the actual comparison:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Return true if the fields match.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Note that the base class is not invoked because it is</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// System.Object, which defines Equals as reference equality.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> (X == p.X) &amp;&amp; (Y == p.Y);
</span></span></code></pre></div><p>The programmer has to check the individual fields and not make any copy and paste errors. If new fields are added, this code <em>must</em> be updated. That&rsquo;s not ideal, but fairly standard when the compiler cannot generate the comparison code for us.</p><p>There is another lurking footgun, where we must be absolutely sure not to call into a base class, or risk infinite recursion, or inadvertently performing reference equality.</p><h3 id=systemobjectgethashcode-override><code>System.Object.GetHashCode</code> override</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>int</span> GetHashCode() =&gt; (X, Y).GetHashCode();
</span></span></code></pre></div><p>There&rsquo;s a rule that if two objects are <em>equal</em>, they must also have the same hash code. This is required for correct operation of dictionaries and other collections that use hash codes to optimise lookup. Because we override <code>Equals</code>, we must also override <code>GetHashCode</code>.</p><p>It&rsquo;s been a while since I used C#. I wonder does the compiler enforce this requirement?</p><p>Again, we access the <code>X</code> and <code>Y</code> fields here, so if any more fields are added, this code should be updated. I say <em>should</em> rather than <em>must</em>, as I understand it&rsquo;s sometimes OK for a hash code to not always use every field. I&rsquo;m not an expert in hashing. I would probably use all fields just to be safe.</p><h3 id=-operator><code>==</code> operator</h3><p>Microsoft also advises that we implement yet another equality mechanism, the <code>==</code> and <code>!=</code> operators.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>operator</span> ==(TwoDPoint lhs, TwoDPoint rhs)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (lhs <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (rhs <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Only the left side is null.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Equals handles case of null on right side.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> lhs.Equals(rhs);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We have to write a few lines of easy-to-get-wrong boilerplate, then we call into one of the previous <code>Equals</code> methods to do the tedious work of doing the null checks, the subclassing checks, and finally, comparing the two integers.</p><p>What a lot of work, to compare such a small number of bytes.</p><h3 id=-operator-1><code>!=</code> operator</h3><p>And finally, the language is not clever enough to implement <code>!=</code> for us when we implement <code>==</code>, so it is added manually:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#66d9ef>operator</span> !=(TwoDPoint lhs, TwoDPoint rhs) =&gt; !(lhs == rhs);
</span></span></code></pre></div><h2 id=swift-and-equatable>Swift and <code>Equatable</code></h2><p>Swift has an elegant solution to equality. The <a href=https://developer.apple.com/documentation/swift/equatable>Equatable</a> protocol contains the following declaration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>func</span> == (lhs: <span style=color:#66d9ef>Self</span>, rhs: <span style=color:#66d9ef>Self</span>) -&gt; Bool
</span></span></code></pre></div><p>To make your type <em>equatable</em>, you declare that it conforms to the <code>Equatable</code> protocol:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TwoDPoint</span>: Equatable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> x: Int
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> y: Int
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The protocol has a default implementation of <code>!=</code> that just calls <code>==</code> and negates the result, so you don&rsquo;t need to provide an implementation of both functions.</p><p>For value types, the compiler (<a href=https://www.swiftbysundell.com/wwdc2018/synthesized-conditional-conformances-in-swift-42/>since 2018</a>) automatically generates the actual <code>==</code> function for you too, so typically all you need to to is declare that your type is <code>Equatable</code> and you&rsquo;re done.</p><p>For classes, you have to write the <code>==</code> function yourself:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TwoDPoint</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> x: Int
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> y: Int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>init</span>(x: Int, y: Int) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.x = x
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.y = y
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>TwoDPoint</span>: Equatable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>func</span> == (lhs: TwoDPoint, rhs: TwoDPoint) -&gt; Bool {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            lhs.x == rhs.x <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            lhs.y == rhs.y
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It normally doesn&rsquo;t make sense to compare variables that are not <em>values</em>, and for values you should use a value type such as <code>struct</code> or <code>enum</code>, so if you find yourself hand-implementing <code>==</code> it&rsquo;s time to think about how you got there.</p><p>Note there are no null checks in <code>==</code> above. Swift separates the concerns of nullability and references. So by the time your class&rsquo; <code>==</code> function is called, the null check has already been done.</p><h2 id=conclusion>Conclusion</h2><p>I hope I&rsquo;ve demonstrated that a typical object-oriented approach to value comparisons quickly gives rise to a whole lot of unnecessary issues. Partly due to being object-oriented, but also due to being overly generic. For example, the C# solution requires that the programmer implement an equality comparison against <em>any other</em> type of object, including nulls, when the 99% <em>actual, concrete use case</em> is that we want to compare <em>non-null values of the same type</em>.</p><p>Swift absolutely nails the 99% use case:</p><ul><li>No boilerplate</li><li><code>Equatable</code> only applies to the specific type that&rsquo;s declared conformant</li><li>Neither side of the <code>==</code> sign is special</li><li>No need to check nulls</li><li>Tedious code is automatically generated</li></ul><p>What wasn&rsquo;t immediately obvious though as we got into the specifics of equality, is that equality is only one basic data transform, and our findings can be extrapolated to cover all kinds of data transforms.</p><p>A data transform is when you take more than one source of data, do some work with them, and output some result.</p><p>If you want to transform data, and if you&rsquo;re reading this then that is what your job is, then:</p><ol><li>You should avoid an object-oriented approach, and</li><li>you should avoid an overly generic approach, as it will definitely make you solve problems you don&rsquo;t have.</li></ol><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">What's in this post</p><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#properties-of-equatability>Properties of equatability</a><ul><li><a href=#equals-expressions-should-be-_commutative_>Equals expressions should be <em>commutative</em></a></li><li><a href=#values-can-only-be-equal-if-they-are-of-the-same-type>Values can only be equal if they are of the same type</a></li><li><a href=#null-references>Null references</a></li></ul></li><li><a href=#deep-dive-into-c>Deep dive into C#</a><ul><li><a href=#systemobjectequals-override><code>System.Object.Equals</code> override</a></li><li><a href=#iequatabletequals-implementation><code>IEquatable&lt;T>.Equals</code> implementation</a></li><li><a href=#systemobjectgethashcode-override><code>System.Object.GetHashCode</code> override</a></li><li><a href=#-operator><code>==</code> operator</a></li><li><a href=#-operator-1><code>!=</code> operator</a></li></ul></li><li><a href=#swift-and-equatable>Swift and <code>Equatable</code></a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://petmac.dev/>&copy; Peter Mackay 2024</a><div><div class=ananke-socials><a href=https://mastodon.gamedev.place/@petmac target=_blank rel=noopener class="ananke-social-link link-transition mastodon link dib z-999 pt3 pt0-l mr1" title="follow on Mastodon - Opens in a new window" aria-label="follow on Mastodon - Opens in a new window"><span class=icon><svg viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a href=https://bsky.app/profile/petmac.bsky.social target=_blank rel=noopener class="ananke-social-link link-transition bluesky link dib z-999 pt3 pt0-l mr1" title="follow on Bluesky - Opens in a new window" aria-label="follow on Bluesky - Opens in a new window"><span class=icon><svg viewBox="0 0 576 512"><path d="M407.8 294.7c-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3zM288 227.1C261.9 176.4 190.9 81.9 124.9 35.3 61.6-9.4 37.5-1.7 21.6 5.5 3.3 13.8.0 41.9.0 58.4S9.1 194 15 213.9c19.5 65.7 89.1 87.9 153.2 80.7 3.3-.5 6.6-.9 10-1.4-3.3.5-6.6 1-10 1.4-93.9 14-177.3 48.2-67.9 169.9C220.6 589.1 265.1 437.8 288 361.1c22.9 76.7 49.2 222.5 185.6 103.4 102.4-103.4 28.1-156-65.8-169.9-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3 64.1 7.1 133.6-15.1 153.2-80.7C566.9 194 576 75 576 58.4s-3.3-44.7-21.6-52.9c-15.8-7.1-40-14.9-103.2 29.8C385.1 81.9 314.1 176.4 288 227.1z"/></svg>
</span></a><a href=https://github.com/petmac/ target=_blank rel=noopener class="ananke-social-link link-transition github link dib z-999 pt3 pt0-l mr1" title="follow on GitHub - Opens in a new window" aria-label="follow on GitHub - Opens in a new window"><span class=icon><svg viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></a><a href=https://twitter.com/petmac target=_blank rel=noopener class="ananke-social-link link-transition twitter link dib z-999 pt3 pt0-l mr1" title="follow on Twitter - Opens in a new window" aria-label="follow on Twitter - Opens in a new window"><span class=icon><svg viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span></a></div></div></div></footer></body></html>